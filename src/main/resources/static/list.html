<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>每月数据</title>
    <link href="assets/css/reset.css" rel="stylesheet" type="text/css" />
    <link href="assets/js/themes/default/easyui.css" rel="stylesheet" type="text/css" />
    <link href="assets/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="assets/css/layout.css" rel="stylesheet" type="text/css" />
</head>
<script src="assets/js/jquery2.1.1.js" type="text/javascript"></script>
<script src="assets/js/jquery.easyui.min.js" type="text/javascript"></script>
<script src="assets/js/layer.js" type="text/javascript"></script>
<body class="padding10">

<div class="tools-row" style="padding-bottom:2px;">
    <!--<table cellpadding="0" cellspacing="0" style="width:100%">
        <tr>
            <td>日清日结每月数据</td>
            &lt;!&ndash;<td style="height:28px;" colspan="2">
                账号:<input class="easyui-textbox" id="txtUserZhxm" data-options="width:80"/>
                &nbsp; &nbsp; <button id="btnsearch" type="button" class="but-default" onclick="UserinfoSearch()"><span class="icon icon-magnifier"></span> 查询</button>
            </td>&ndash;&gt;
            <td align="right">
                &lt;!&ndash;<button id="btnadd" type="button" class="easyui-linkbutton btnPrimary"  onclick="EidtUserForm()"><span class="icon icon-add"></span>新增</button>&ndash;&gt;
                <button id="btndel" type="button" class="easyui-linkbutton   btnDanger"  onclick="User_Del()"><span class="icon icon-delete"></span>删除</button>
            </td>
        </tr>
    </table>-->
    <div class="btnbar-tools">
       <!-- <a href="javascript:;" class="add" id="newData"><i class="fa fa-plus-square success"></i>添加</a>-->
        <!--<a href="javascript:;" class="edit"><i class="fa fa-pencil-square info"></i>编辑</a>-->
        <a href="javascript:;" class="del" id="delData" onclick="Fn_Del()"><i class="fa fa-times-rectangle danger"></i>删除</a>
       <!-- <a href="javascript:;" class="count"><i class="fa fa-pie-chart purple"></i>统计</a>
        <a href="javascript:;" class="check"><i class="fa fa-check-circle yellow"></i>审核</a>-->
    </div>
</div>
<table id="dg"></table>
<div class="div_empty" style="height: 150px; display:none; border-top: 0px solid; background-color:White;">
    <div style="width: 95%; text-align: center; border: 0px; margin-top: 5%; font-size:20px; font-family: 宋体;position: absolute">
        暂无数据！
    </div>
</div>
<!--
<div id="window_userinfo" class="easyui-window" title="修改数据"
     data-options="modal:true,closed:true,region:'center'">
    <form id="yzxx" method="post">
        <table cellpadding="5" class="basetable">
            <tr>
                <td>
                   事业部名称：
                </td>
                <td>
                    <input class="easyui-textbox" id="txtuserid" placeholder="自动生成" type="text" name="username"></input>
                </td>
            </tr>
            <tr>
                <td>
                    用户账号：
                </td>
                <td>
                    <input class="easyui-textbox" id="txtuserzh" type="text" name="username" data-options="required:true"></input>
                </td>
            </tr>
            <tr>
                <td>
                    姓名：
                </td>
                <td>
                    <input class="easyui-textbox" id="txtusername" type="text" name="username" data-options="required:true"></input>
                </td>
            </tr>

            <tr>
                <td>
                    密码:
                </td>
                <td>
                    <input id="password1" class="easyui-textbox" type="password" data-options="required:true,validType:'length[6,50]'" />
                </td>
            </tr>
            <tr>
                <td>
                    确认密码:
                </td>
                <td>
                    <input id="password2" class="easyui-textbox" type="password" data-options="required:true,validType:'length[6,50]'" />
                </td>
            </tr>

            <tr>
                <td>
                    角色：
                </td>
                <td>

                </td>
            </tr>
            <tr>
                <td>
                    用户状态：
                </td>
                <td colspan="3">
                    <input id="stauts1" type="radio" name="status" value="1" /><label for="stauts0">启用</label>
                    <input id="stauts0" type="radio" name="status" value="0" /><label for="stauts1">禁用</label>
                </td>
            </tr>
            <tr>
                <td colspan="4" align="right">
                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-save'" style="width: 80px"
                       onclick="SaveUserInfo()">保存</a> <a href="javascript:void(0)" class="easyui-linkbutton"
                                                          data-options="iconCls:'icon-cancel'" onclick="$('#window_userinfo').window('close')" style="width: 80px">
                    取消</a>
                </td>
            </tr>
        </table>
    </form>
</div>-->
<!-- 新增和编辑数据 -->
<div class="dig-wrapper" id="newData-wrapper">
    <div class="form2-column" title="表单示例">
        <form id="vui_sample" class="easyui-form" method="post" data-options="novalidate:true">
            <input class="easyui-textbox" type="hidden"  name="id" id="id" value="0" />
            <div class="form-column2">
                <div class="form-column-left">
                    <input class="easyui-textbox" name="yearno" id="yearNo" style="width:100%" data-options="label:'年份:',required:true">
                </div>
                <div class="form-column-left fm-left">
                    <input class="easyui-textbox" name="monthno" id="monthNo" style="width:100%" data-options="label:'月份:',required:true">
                </div>
            </div>

            <div class="form-column2">
                <div class="form-column-left">
                    <input class="easyui-textbox" name="companyname"  id="companyName" style="width:100%" data-options="label:'事业部名称:',required:true">
                </div>
                <div class="form-column-left fm-left">
                    <input class="easyui-textbox" name="rcvnum" id="rcvNum" style="width:100%" data-options="label:'接收超标:',required:true">
                </div>
            </div>

            <div class="form-column2">
                <div class="form-column-left">
                    <input class="easyui-textbox" name="outallnum" id="outAllNum" style="width:100%" data-options="label:'发货单总量:',required:true">
                </div>
                <div class="form-column-left fm-left">
                    <input class="easyui-textbox" name="checknum" id="checkNum" style="width:100%" data-options="label:'检验超标:',required:true,validType:'number'">
                </div>
            </div>
            <div class="form-column2">
                <div class="form-column-left">
                    <input class="easyui-textbox" name="instocknum" id="inStockNum"  style="width:100%" data-options="label:'入库超标:',required:true">
                </div>
                <div class="form-column-left fm-left">
                    <input class="easyui-textbox" name="purchaseallnum" id="purchaseAllNum"  style="width:100%" data-options="label:'入库总数:',required:true">
                </div>
            </div>
            <div class="form-column2">
                <div class="form-column-left">
                    <input class="easyui-textbox" name="purchasemoney" id="purchaseMoney"  style="width:100%" data-options="label:'采购总价:',required:true">
                </div>
                <div class="form-column-left fm-left">
                    <input class="easyui-textbox" name="gapmoney" id="gapMoney"  style="width:100%" data-options="label:'采购价差:',required:true">
                </div>
            </div>
            <div class="form-column2">
                <div class="form-column-left">
                    <input class="easyui-textbox" name="invoicehand" id="invoiceHand"  style="width:100%" data-options="label:'手工价差:',required:true">
                </div>
                <div class="form-column-left fm-left">
                    <input class="easyui-textbox" name="invoiceten" id="invoiceTen"  style="width:100%" data-options="label:'10%<=发票价差<50%:',required:true">
                </div>
            </div>
            <div class="form-column2">
                <div class="form-column-left">
                    <input class="easyui-textbox" name="invoicefive" id="invoiceFive"  style="width:100%" data-options="label:'50%<=发票价差<100%:',required:true">
                </div>
                <div class="form-column-left fm-left">
                    <input class="easyui-textbox" name="invoicebai" id="invoiceBai"  style="width:100%" data-options="label:'100%<=发票价差:',required:true">
                </div>
            </div>
            <div class="form-column2">
                <div class="form-column-left">
                    <input class="easyui-textbox" name="invoicediff" id="invoiceDiff"  style="width:100%" data-options="label:'发票异常数目:',required:true">
                </div>
                <div class="form-column-left fm-left">
                    <input class="easyui-textbox" name="invoicenum" id="invoiceNum"  style="width:100%" data-options="label:'发票总数:',required:true">
                </div>
            </div>
        </form>
       <!-- <div class="form-btnBar pl75">
            <input type="submit" id="commit" value="保存" class="easyui-linkbutton btnPrimary" onclick="submitForm()" style="width:80px" />
            <input type="reset" name="" value="重置" class="easyui-linkbutton btnDefault" onclick="clearForm()" style="width:80px" />
        </div>-->
    </div>
</div>
<iframe id="ifile" style="display:none"></iframe>
<script type="text/javascript">
    $(document).ready(function() {

        BindData = function () {
            var queryParams = GetqueryParams();
            $('#dg').datagrid({
                width: '100%',
                height: 'auto',
                scrollbarSize: 0,
                autoRowHeight: false,
                url: "/busy/query",
                queryParams: queryParams,
                checkOnSelect: false,
                selectOnCheck: true,
                idField: 'id',
                columns: [[
                    {field: 'ck', title: '选择', sortable: true, checkbox: true},
                    {field: 'companyName', title: '事业部名称', width: "7%", sortable: true},
                    {field: 'companyId', title: '事业部id', hidden: true},
                    {field: 'yearNo', title: '年份', width: "7%", sortable: true},
                    {field: 'monthNo', title: '月份', width: "7%", sortable: true},
                    {field: 'outAllNum', title: '发货单总量', width: "7%", sortable: true},
                    {field: 'rcvNum', title: '接收超标', width: "7%", sortable: true},
                    {field: 'outday', title: '超标天数', width: "7%", sortable: true},
                    {field: 'purchaseAllNum', title: '入库总数', width: "7%", sortable: true},
                    {field: 'checkNum', title: '检验超标', width: "7%", sortable: true},
                    {field: 'inStockNum', title: '入库超标', width: "8%", sortable: true},
                    {field: 'invoiceHand', title: '手工价差', width: "8%", sortable: true},
                    {field: 'invoiceDiff', title: '异常价差', width: "8%", sortable: true},
                    {field: 'invoiceNum', title: '发票总数', width: "8%", sortable: true},
                    /*{ field: 'status', title: '状态', width: "20%", sortable: true,formatter:function(value, row, index){
                return row.zt;
            }  },*/
                    /*{ field: 'role', title: '角色', width: "20%", sortable: true ,formatter:function(value, row, index){
                return row.dmmc;
            }  },*/
                    {
                        field: 'action', title: '操作', width: "8%", align: 'center',
                        formatter: function (value, row, index) {
                            var e = '<a class="but-link" href="javascript:void(0)" onclick="EidtUserForm(this)" title="编辑"> <i class="fa fa-pencil-square info"></i></a> '+
                                '　<a class="but-link" href="javascript:void(0)" onclick="exportRow(this)" title="导出"> <i class="fa fa-plus-circle info"></i></a> ';
                            return e;
                        }
                    }
                ]],
                onLoadSuccess: function (data) {//加载完毕后获取所有的checkbox遍历
                    if (data.rows.length > 0) {
                        //循环判断操作为新增的不能选择
                        /* for (var i = 0; i < data.rows.length; i++) {
                    //根据userid让某些行不可选
                    if (data.rows[i].userid == "system") {
                        $("input[type='checkbox']")[i + 1].disabled = true;//禁用
                        //$("input[type='checkbox']")[i + 1].remove();//移除
                    }
                }*/

                    } else {
                        $(".div_empty").css({"display": "block"});
                        $(this).closest('div.datagrid-wrap').find('div.datagrid-pager').hide();
                    }

                },
                //当用户勾选全部行时触发
                onCheckAll: function (rows) {
                    $("input[type='checkbox']").each(function (index, el) {
                        if (el.disabled == true) {
                            $("#dg").datagrid('uncheckRow', index - 1);//此处参考其他人的代码，原代码为unselectRow
                        }
                        var checkboxHeader = $('div.datagrid-header-check input[type=checkbox]');//取到全选全不选这个元素
                        checkboxHeader.prop("checked", "checked");//将其设置为checked即可
                    });
                },
                onClickRow: function (rowIndex, rowData) {
                    //加载完毕后获取所有的checkbox遍历
                    $("input[type='checkbox']").each(function (index, el) {
                        //如果当前的复选框不可选，则不让其选中
                        if (el.disabled == true) {
                            //POSStockHeadTable.datagrid('unselectRow', index - 1);
                        }
                    })
                },
                pageSize: 10,
                pageList: [10, 20, 30, 50],
                fitColumns: true,
                striped: true,
                pagination: true, //分页控件
                rownumbers: true, //行号
                onLoadError: function (e) {
                    $.messager.alert("提示", "加载失败", "error");
                }
            });

        }
        //当请求远程数据时，发送的额外参数。
        GetqueryParams= function () {
            var Params = {};
            //Params.SearchRole = $("#SearchRole").combobox('getValue');
            //Params.Jzzhch = $("#txtUserZhxm").textbox('getValue');
            return Params;
        }

        UserinfoSearch= function () {
            $("#dg").datagrid("reload", GetqueryParams());
        }

        //删除
        Fn_Del= function () {
            var rows = $('#dg').datagrid("getSelections");

            if (rows.length > 0) {
                $.messager.confirm("提示", "你确定要删除吗?", function (r) {
                    if (r) {
                        var ids = [];
                        for (var i = 0; i < rows.length; i++) {
                            ids.push(rows[i].id);
                        }
                        var jsonObject = JSON.stringify(ids);
                        DelRows(ids);
                    }
                });
            }
            else {
                $.messager.alert("提示", "请选择要删除的行", "error");
            }
        }

        DelRows = function (ids) {
            var param = {ids:ids};
            $.ajax({
                type: 'get',
                dataType: "json", //返回json格式的数据
                url: "/busy/deleteByIds",
                data: param,
                cache: false,
                success: function (data) {
                    if (data.success) {
                        $('#dg').datagrid("reload");
                        $.messager.alert("提示", "删除成功");
                    }
                    else {
                        $.messager.alert("提示", "删除失败", "error");
                    }
                },
                error: function (e) {
                    var msg = responseTextTitle(e.responseText);
                    $.messager.alert("提示", msg, "error");
                }
            });
        }

        GetRowIndex = function(target) {
            var tr = $(target).closest('tr.datagrid-row');
            return parseInt(tr.attr('datagrid-row-index'));
        }

        EidtUserForm = function(target){
            if (target) {
                var thisindex = GetRowIndex(target);
                var row = $('#dg').datagrid('getRows')[thisindex];
                $('#id').textbox('setValue',row.id);
                $('#yearNo').textbox('setValue',row.yearNo);
                $('#monthNo').textbox("setValue",row.monthNo);
                $('#companyName').textbox('setValue',row.companyName);
                $('#companyName').textbox('readonly',true);
                $('#outAllNum').textbox('setValue',row.outAllNum);
                $('#rcvNum').textbox("setValue",row.rcvNum);
                $('#checkNum').textbox("setValue",row.checkNum);
                $('#purchaseAllNum').textbox("setValue", row.purchaseAllNum);
                $('#inStockNum').textbox("setValue", row.inStockNum);
                $('#purchaseMoney').textbox("setValue", row.purchaseMoney);
                $('#gapMoney').textbox("setValue", row.gapMoney);
                $('#invoiceHand').textbox("setValue", row.invoiceHand);
                $('#invoiceTen').textbox("setValue", row.invoiceTen);
                $('#invoiceFive').textbox("setValue", row.invoiceFive);
                $('#invoiceBai').textbox("setValue", row.invoiceBai);
                $('#invoiceDiff').textbox("setValue", row.invoiceDiff);
                $('#invoiceNum').textbox("setValue", row.invoiceNum);
                /*$('#purchaseAllNum').combobox('setValues', row.purchaseAllNum);
                $("input[name='status'][value=" + row.status + "]").prop("checked", true);*/
                $('#dg').datagrid('clearSelections');
                layer.open({
                    type: 1,
                    skin: 'layui-layer-rim', //加上边框
                    area: ['1000px', '500px'], //宽高
                    content: $('#newData-wrapper'),
                    btn: ['提交',  '关闭','导出']
                    ,btn1: function(index, layero){
                        //按钮【按钮一】的回调
                        submitForm(layer,index);
                    }
                    ,btn2: function(index, layero){
                        //return false ;//开启该代码可禁止点击该按钮关闭
                     },btn3:function(index,lavero){
                        exportRow(index);
                        return false;
                    },
                    zIndex: 1000
                });
            }
        }

        submitForm = function (layeror,index){//保存提交
            $('#vui_sample').form('submit',{
                url: 'busy/saveinfo',
                onSubmit:function(){
                    return $(this).form('enableValidation').form('validate');
                },
                success:function(data){
                    data = eval( '('+data+')' );
                    if(data.success==true){
                        $.messager.alert("提示", "编辑成功");
                        $('#dg').datagrid("reload");
                    }else{
                        $.messager.alert( "提示","编辑失败");
                    }
                    layeror.close(index);
                }
            });
        }

        exportRow = function(target){
            if (target) {
                var thisindex = GetRowIndex(target);
                var row = $('#dg').datagrid('getRows')[thisindex];
                var cid = row.companyId;
                var year = row.yearNo;
                var month = row.monthNo;
                var url = "/busy/exportOneMonth?cid="+cid+"&year="+year+"&month="+month;
                var dom=document.getElementById('ifile');
                dom.src=url;
            }
        }



       /* clearForm = function (){//重置表单
            $('#vui_sample').form('clear');
        }*/


        /*
    function EidtUserForm(target) {
        var title="编辑";
        if (target) {
            var thisindex = getRowIndex(target);
            var row = $('#dg').datagrid('getRows')[thisindex];
            $('#txtuserid').textbox('readonly',true);
            $('#txtuserzh').textbox('readonly',true);
            $('#txtuserid').textbox("setValue",row.userid);
            $('#txtuserzh').textbox('setValue',row.userzh);
            $('#password1').textbox("setValue","");
            $('#password2').textbox("setValue","");
            $('#txtusername').textbox("setValue", row.username);
            $('#userrole').combobox('setValues', row.role);
            $("input[name='status'][value=" + row.status + "]").prop("checked", true);
            $('#dg').datagrid('clearSelections');
        }
        else {
            $('#txtuserid').textbox('readonly',true);
            $('#txtuserzh').textbox('setValue',"");
            $('#txtuserzh').textbox('readonly',false);
            $('#txtuserid').textbox("setValue","");
            $('#password1').textbox("setValue","");
            $('#password2').textbox("setValue","");
            $('#txtusername').textbox("setValue", "");
            $('#userrole').combobox('setValues', "");
            $("input[name='status'][value='1']").prop("checked", true);
            title="新增";
        }
        $('#window_userinfo').window({
            width: 500,
            title: title,
            modal: true
        });
        $('#window_userinfo').window('open');
        $('#window_userinfo').window('vcenter');
        $('#window_userinfo').window('hcenter');
    }*/
        /*function SaveUserInfo()
    {
       /!* var isValid = $("#yzxx").form('enableValidation').form('validate');
        if (!isValid) {
            $.messager.progress('close'); // hide progress bar while the form is invalid
            return isValid;
        }
        if($('#password1').textbox("getValue")!=$('#password2').textbox("getValue"))
        {
            $.messager.alert("提示", "两次密码输入不一样", "");
            return false;
        }
        if($('#userrole').combobox("getValues")=="")
        {
            $.messager.alert("提示", "请选择角色", "");
            return false;
        }*!/
        //var userinfo = $('#yzxx').serializeObject();
        var userinfo = new Object();
        userinfo.userid=$('#txtuserid').textbox("getValue");
        userinfo.userzh=$('#txtuserzh').textbox("getValue");
        userinfo.username=$('#txtusername').textbox("getValue");
        userinfo.passwd=$('#password1').textbox("getValue");
        userinfo.role=$('#userrole').combobox('getValue');
        userinfo.status=$("input[name='status']:checked").val();
        var jsonObject = JSON.stringify(userinfo);
        $.ajax({
            type: 'post',
            dataType: "json",
            url: "****",
        data: { 'json': jsonObject },
        cache: false,
            success: function (data) {
        if (data == "1") {
            $.messager.alert("提示", "保存成功", "");
            $('#dg').datagrid("reload");
            $('#window_userinfo').window('close');
        }
        else {
            $.messager.alert("提示", data.msg, "error");
        }
    },
        error: function (e) {
            $.messager.alert("提示", "保存失败" + e.toString(), "error");
        }
    });
    }*/

        /*初始化数据*/
        BindData();
        //新增数据
        /*$('#edit').on('click', function () {
            layer.open({
                type: 1,
                skin: 'layui-layer-rim', //加上边框
                area: ['1000px', '450px'], //宽高
                content: $('#newData-wrapper'),
                zIndex: 1000
            });
        });*/

       /* $('#delData').on('click', function () {
            var rows = $("#dg").datagrid("getChecked");
            if (rows.length == 0) {
                $.messager.alert("提示", "请选择要删除！", "info");
                return;
            }
            $.messager.confirm("确认", "确定要删除？", function (isok) {
                if (isok) {
                    var md = [];
                    $.each(rows, function (index, row) {
                        md.push(row.id);
                    })
                    var ids = md.join(',');
                    $.ajax({
                        url: "/busy/deleteCheck",
                        type: "post",
                        data: { ids: ids },
                        dataType: 'json',
                        success: function (data) {
                            if (data.flag == "1") {
                                reload();
                            }
                            else {
                                $.messager.alert("提示", data.msg);
                            }
                        }
                    })
                }
            })
        });*/


    });
</script>

</body>
</html>